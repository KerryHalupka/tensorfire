<body>
<script src="../../dist/demo-util.js"></script>
<script src="../../dist/tensor.js"></script>

<style type="text/css">
    body {
        font-family: sans-serif;
    }
</style>
<h1>ResNet-50</h1>

<script src="layers.js"></script>
<script src="util.js"></script>
<script src="network.js"></script>
<script src="imagenet.js"></script>
<script src="keras_import.js"></script>
<progress value="0" max="1" id="progress" style="width: 100%"></progress>

<script>
var gl = KV.createGL(),
    OutputTensor = KV.OutputTensor,
    Tensor = KV.Tensor,
    InPlaceTensor = KV.InPlaceTensor,
    TP = s => (out, opt) => KV.Run(s.join(''), out, opt);
gl.canvas.width = 512
gl.canvas.height = 512


function h(type, children = []){
    var el = document.createElement(type);
    (Array.isArray(children) ? children : [ children ])
        .forEach(k => el.appendChild(typeof k != 'object' ? 
            document.createTextNode(k) : k));
    return el
}


async function resnet(){
    var keras_model = await loadJSON('models/resnet50.json');
    var keras_model_meta = await loadJSON('models/resnet50_metadata.json');
    var buffer = await loadBuffer('models/resnet50_weights.buf');

    console.log(keras_model, keras_model_meta, buffer)
    
    var image = (await loadArrayFromURL('data/cat-227x227x3')).transpose(1, 0, 2).hi(224, 224, null);
    ;(new Tensor(gl, image)).show({ offset: 0.5, scale: 1/256, flipY: true })


    var network = import_keras_network(keras_model, keras_model_meta, buffer)


    var compiled = await compile(gl, network, { input_1: image, 
        progress: async function(amount){
            document.getElementById('progress').value = amount;
            await new Promise(resolve => requestAnimationFrame(resolve))
        } 
    })
    C = compiled

    await new Promise(resolve => requestAnimationFrame(resolve))

    
    console.time('running network')
    await run(gl, compiled, { input_1: image, layerPause: false })
    compiled.info.fc1000.output.show({ offset: 0.5, scale: 1, flipY: true })

    



    var results = Array.from(compiled.info.fc1000.output.read().data)
        .map((k, i) => [imagenetClasses[i][1], k])
        .sort((b, a) => a[1] - b[1])
        .slice(0, 10);

    console.timeEnd('running network')

    var table = h('table', h('tbody', 
        results.map(k => 
            h('tr', [
                h('td', k[0]),
                h('td', k[1])
            ])
        )
    ))
    document.body.appendChild(table)
    // await destroy(gl, compiled)



}

resnet()

</script>