<body>
<script src="../../dist/demo-util.js"></script>
<script src="../../dist/tensor.js"></script>

<script>
var gl = KV.createGL(),
    OutputTensor = KV.OutputTensor,
    Tensor = KV.Tensor,
    InPlaceTensor = KV.InPlaceTensor,
    TP = s => (out, opt) => KV.Run(s.join(''), out, opt);


const MatrixMultiply = TP`
    uniform Tensor a;
    uniform Tensor b;
   
    vec4 process(ivec4 pos) {
        vec4 sum = vec4(0, 0, 0, 0);
        for(int k = 0; k < #(a.shape).y; k++){
            sum += readTensor(a, ivec4(pos.x, k, pos.wz))
                 * readTensor(b, ivec4(k, pos.y, pos.wz));
        }
        return sum;
    }
`;


function MatrixPower(base, n){
	if(n <= 0) throw new Error("can not raise to zeroth power");

	var a = base.copy('float32', InPlaceTensor),
		res = a.copy('float32', InPlaceTensor);

	n--
	while(n > 0){
		if(n % 2 == 0){
			MatrixMultiply(a, { a: a, b: a })	
			n /= 2
		}
		MatrixMultiply(res, { a: res, b: a })
		n--
	}
	return res
}

function ComputeNthFibonacci(n){
	return MatrixPower(Q, n).read().get(0, 1, 0, 0)
}

function testFib(){
	var nums = []
	for(var i = 1; i < 15; i++){
		nums.push(ComputeNthFibonacci(i))
	}
	return nums
}

var Q = new Tensor(gl, ndpack([[1, 1], [1, 0]]));


console.log(testFib())
console.log([1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, 233, 377])

console.log(ComputeNthFibonacci(42))
</script>