<body>
<script src="../../dist/demo-util.js"></script>
<script src="../../dist/tensor.js"></script>
<style type="text/css">
    body {
        font-family: sans-serif;
    }
</style>
<h1>WebGL Matrix Inverse</h1>
<p>Click anywhere on the page to toggle between the original augmented matrix and the result after Gauss-Jordan elimination.</p>

<script>
var gl = KV.createGL(),
    OutputTensor = KV.OutputTensor,
    Tensor = KV.Tensor,
    InPlaceTensor = KV.InPlaceTensor,
    TP = s => (out, opt) => KV.Run(s.join(''), out, opt);



const EliminationStep = TP`
    uniform Tensor mat;
    uniform int k;

    vec4 process(ivec4 pos) {
        if(pos.x > k){
            if(pos.y > k){
                return readTensor(mat, pos) - readTensor(mat, k, pos.y)
                    * (readTensor(mat, pos.x, k) / readTensor(mat, k, k));  
            }else{
                return vec4(0, 0, 0, 0);
            }
        }
        return readTensor(mat, pos);
    }
`;

const BackSubstitute = TP`
    uniform Tensor mat;
    uniform int k;

    vec4 process(ivec4 pos) {
        if(pos.x == k){
            return readTensor(mat, pos) / readTensor(mat, k, k);
        }else{
            return readTensor(mat, pos) - readTensor(mat, k, pos.y) * (
                    readTensor(mat, pos.x, k) / readTensor(mat, k, k));    
        }
    }
`;

gl.canvas.height = 512
gl.canvas.width = 1024

var matrix = zeros([512, 512])
ndops.random(matrix)

// construct the augmented matrix
var augmented = zeros([ matrix.shape[0], matrix.shape[1] * 2 ])
ndops.assign(augmented.hi(null, matrix.shape[0]), matrix)
for(var i = 0; i < matrix.shape[0]; i++)
    augmented.set(i, i + matrix.shape[0], 1);

var orig = new Tensor(gl, augmented)
var mat = new InPlaceTensor(gl, augmented)

console.time('inverting matrix')
for(var k = 0; k < mat.shape[0]; k++){
    EliminationStep(mat, { mat: mat, k: k })
}
for(var k = mat.shape[0] - 1; k >= 0; k--){
    BackSubstitute(mat, { mat: mat, k: k })
}
mat.read()
console.timeEnd('inverting matrix')

show(mat)

function show(m){ m.show({ scale: 1/5, offset: 0.5, transpose: true, flipY: true, channels: 1 }) }

var viewMode = true;
document.body.onclick = function(){
    show((viewMode = !viewMode) ? mat : orig)
}

</script>