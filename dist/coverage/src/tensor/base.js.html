<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/tensor/base.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/tensor</a> base.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">73.58% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>39/53</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">61.22% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>30/49</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>6/6</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">77.78% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>35/45</span>
      </div>
    </div>
  </div>
  <div class='status-line medium'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79x</span>
<span class="cline-any cline-yes">79x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">79x</span>
<span class="cline-any cline-yes">79x</span>
<span class="cline-any cline-yes">241x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">75x</span>
<span class="cline-any cline-yes">75x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">75x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-yes">74x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">106x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-yes">105x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">106x</span>
<span class="cline-any cline-yes">23x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1137x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { makeTexture, makeFrameBuffer, checkRenderFloat } from './helpers.js'
import Formats from '../format/index.js'
&nbsp;
// The tensor format is a JSON object that specifies how 
// the tensor is represented as a texture
// it consists of several keys:
&nbsp;
//     type: uint8 | float32
//     density: 4:4 | 1:4
//     pack: stride | tile
//     codec: 
//			softfloat | fixnum (1:4)
//          raw | linquant (4:4)
&nbsp;
export default class BaseTensor {
	// we arent using a constructor because we want to be able to run
	// this instanceof OutputTensor from within the Tensor constructor
	
	_init(gl, format, shape, data){
		// validate glcontext
		<span class="missing-if-branch" title="if path not taken" >I</span>if(!gl.createTexture) <span class="cstat-no" title="statement not covered" >throw new Error('Invalid WebGLRenderingContext');</span>
		this.gl = gl;
&nbsp;
		// validate shape
		<span class="missing-if-branch" title="if path not taken" >I</span>if(!Array.isArray(shape)) <span class="cstat-no" title="statement not covered" >throw new Error("shape must be Array");</span>
		<span class="missing-if-branch" title="if path not taken" >I</span>if(shape.length &gt; 4) <span class="cstat-no" title="statement not covered" >throw new Error("Tensor must have dimension &lt;= 4");</span>
        if(shape.some(k =&gt; !isFinite(k) || k &lt; 1 || !Number.isInteger(k))) 
            throw new Error('Invalid shape: ' + shape);
        shape = shape.concat([1, 1, 1, 1]).slice(0, 4)
		this.shape = shape;
		
		// validate format
		if(!['float32', 'uint8'].includes(format.type))
			throw new Error('format.type must be uint8 or float32');
		<span class="missing-if-branch" title="else path not taken" >E</span>if(format.density in Formats){
			let fd = Formats[format.density];
			<span class="missing-if-branch" title="if path not taken" >I</span>if(!(format.pack in fd.pack)) 
<span class="cstat-no" title="statement not covered" >				throw new Error('format.pack must be ' + Object.keys(fd.pack).join(' or '));</span>
			<span class="missing-if-branch" title="if path not taken" >I</span>if(!(format.codec in fd.codec)) 
<span class="cstat-no" title="statement not covered" >				throw new Error('format.codec must be ' + Object.keys(fd.codec).join(' or '));</span>
		}else <span class="cstat-no" title="statement not covered" >throw new Error('format.density must be ' + Object.keys(Formats).join(' or '));</span>
&nbsp;
		this.format = format;
&nbsp;
		// calculate texture size
		this.info = Object.assign({},
			this._format.pack.init(shape, format),
			this._format.codec.init(shape, format)
		);
		<span class="missing-if-branch" title="if path not taken" >I</span>if(!this.info.texSize) <span class="cstat-no" title="statement not covered" >throw new Error('Format did not yield texSize');</span>
&nbsp;
		// initialize texture
		this.tex = makeTexture(gl);
		this.update(data)
	}
	_update(data){
		if(data !== null){
			<span class="missing-if-branch" title="else path not taken" >E</span>if(this.format.type === 'uint8'){
				if(Array.isArray(data) || data instanceof Uint8ClampedArray)
					data = new Uint8Array(data);
				<span class="missing-if-branch" title="if path not taken" >I</span>if(!(data instanceof Uint8Array))
<span class="cstat-no" title="statement not covered" >					throw new Error('data must be Uint8Array');</span>
			}else <span class="cstat-no" title="statement not covered" >if(this.format.type === 'float32'){</span>
<span class="cstat-no" title="statement not covered" >				if(Array.isArray(data) || data instanceof Float64Array)</span>
<span class="cstat-no" title="statement not covered" >					data = new Float32Array(data);</span>
<span class="cstat-no" title="statement not covered" >				if(!(data instanceof Float32Array))</span>
<span class="cstat-no" title="statement not covered" >					throw new Error('data must be Float32Array');</span>
			}else <span class="cstat-no" title="statement not covered" >throw new Error('Type must be uint8 or float32');</span>
			if(data.length !== this.info.texSize[0] * this.info.texSize[1] * 4)
				throw new Error('data is the wrong length');
		}
		var gl = this.gl;
        gl.bindTexture(gl.TEXTURE_2D, this.tex);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, 
        	this.info.texSize[0], this.info.texSize[1], 0, gl.RGBA, 
        	this.format.type == 'uint8' ? gl.UNSIGNED_BYTE : <span class="branch-1 cbranch-no" title="branch not covered" >gl.FLOAT,</span> data);
	}
&nbsp;
	update(data){
		if(!data) return this._update(null);
		if(data.shape) return this._update(
			this._format.pack.pack(this.info, data, this._format.codec.encode, this.format));
		<span class="missing-if-branch" title="else path not taken" >E</span>if(this.type != 'uint8') console.warn('Calling update with raw TypedArray may not work across all browsers.');
		return this._update(data);
	}
&nbsp;
	get _format(){
		return {
			pack: Formats[this.format.density].pack[this.format.pack],
			codec: Formats[this.format.density].codec[this.format.codec],
			activations: Formats[this.format.density].activations,
			read_shim: Formats[this.format.density].read_shim,
			write_shim: Formats[this.format.density].write_shim
		}
	}
&nbsp;
    destroy(){ this.gl.deleteTexture(this.tex) }
}</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Jul 10 2017 05:33:54 GMT-0700 (PDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
